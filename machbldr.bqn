# CBQN/BQN machbldr.bqn
# bqns machbldr.bqn --projects ssacore swsservice --actions build --clean

# tests
# args â† "--projects"â€¿"ssacore"â€¿"swsservice"â€¿"--actions"â€¿"build"â€¿"--clean"

GetValue â† {((0âŠ‘ğ•¨)âŠâŸ¨ğ•©âŸ©)âŠ‘1âŠ‘ğ•¨}  # TODO clean, tacit

GetValueDefault â† {ğ•¨ {âŠ‘âŸ¨ğ•©âŸ©âˆŠ0âŠ‘ğ•¨}â—¶{ğ•¨ GetValue "default"}â€¿{ğ•¨ GetValue ğ•©} ğ•©}  # TODO clean, tacit

args_short â† âŸ¨
  "-p"â€¿"--projects"
  "-a"â€¿"--actions"
âŸ©

mlibraries â† âŸ¨
  "ssacore"
  "turboprop"
  "sdacore"
  "svslib"
  "xcomlib"
âŸ©
â€¢Out "mlibraries: "âˆ¾â€¢Fmt mlibraries

mapplications â† âŸ¨
  "swsservice"
  "catalogservice"
  "xcom"
  "tpmservice"
  "traidservice"
  "age"
  "SatView"
  "Obs2Tle"
âŸ©

mexc_paths â† âŸ¨
  "swsservice"â€¿"swsservice/bin/sws-service"
  "catalogservice"â€¿"catalogservice/bin/CatalogCoordinator"
  "xcom"â€¿"xcom/bin/xcom"
  "tpmservice"â€¿"tpmservice/bin/tpm"
  "traidservice"â€¿"traidservice/bin/Traid"
  "age"â€¿"age/bin/age"
  "SatView"â€¿"core/tools/SatView/SatView"
  "Obs2Tle"â€¿"core/tools/Obs2Tle/Obs2Tle"
âŸ©

#def get_dirproj(project):
#    if project == "SatView":
#        return "core/tools/SatView"
#    if project == "Obs2Tle":
#        return "core/tools/Obs2Tle"
#    else:
#        return project

mproject_deps â† <Ë˜â‰>âŸ¨
  "ssacore"â€¿âŸ¨âŸ©
  "turboprop"â€¿âŸ¨âŸ©
  "sdacore"â€¿âŸ¨"ssacore", "turboprop"âŸ©
  "catalogservice"â€¿âŸ¨"sdacore"âŸ©
  "swsservice"â€¿âŸ¨"sdacore"âŸ©
  "svslib"â€¿âŸ¨"sdacore"âŸ©
  "xcomlib"â€¿âŸ¨"sdacore"âŸ©
  "xcom"â€¿âŸ¨"xcomlib", "svslib"âŸ©
  "traidservice"â€¿âŸ¨"sdacore"âŸ©
  "tpmservice"â€¿âŸ¨"sdacore"âŸ©
  "age"â€¿âŸ¨"sdacore"âŸ©
  "SatView"â€¿âŸ¨"sdacore"âŸ©
  "Obs2Tle"â€¿âŸ¨"sdacore"âŸ©
âŸ©

mcleans â† <Ë˜â‰>âŸ¨
  "packages-install"â€¿"packages-install-clean"
  "config"â€¿"config-clean"
  "build"â€¿"build-clean"
âŸ©

#def get_project_deps(prj):
#    if prj not in _project_deps:
#        return [prj]
#    return (
#        list(
#            itertools.chain.from_iterable(
#                get_project_deps(x)
#                for x in _project_deps[prj]
#            ))
#        + [prj]
#    )

mprojects â† mlibraries âˆ¾ mapplications

mactions â† <Ë˜â‰>âŸ¨
    "packages-install-clean"â€¿(<Ë˜â‰>âŸ¨
        "default"â€¿âŸ¨
          "rm -rf {dirproj}/conan/conan.lock"
          "rm -rf {dirproj}/conan/conanbuildinfo.cmake"
          "rm -rf {dirproj}/conan/conanbuildinfo.mak"
          "rm -rf {dirproj}/conan/conanbuildinfo.txt"
          "rm -rf {dirproj}/conan/conaninfo.txt"
          "rm -rf {dirproj}/conan/graph_info.json"
        âŸ©
        "SatView"â€¿âŸ¨âŸ©
        "Obs2Tle"â€¿âŸ¨âŸ©
    âŸ©)
    "packages-install"â€¿(<Ë˜â‰>âŸ¨
        "default"â€¿âŸ¨
          "rm -rf {dirproj}/conan/conan.lock"
          "rm -rf {dirproj}/conan/conanbuildinfo.cmake"
          "rm -rf {dirproj}/conan/conanbuildinfo.mak"
          "rm -rf {dirproj}/conan/conanbuildinfo.txt"
          "rm -rf {dirproj}/conan/conaninfo.txt"
          "rm -rf {dirproj}/conan/graph_info.json"
        âŸ©
        "ssacore"â€¿âŸ¨âŸ©
        "turboprop"â€¿âŸ¨âŸ©
        "SatView"â€¿âŸ¨âŸ©
        "Obs2Tle"â€¿âŸ¨âŸ©
    âŸ©)
    "pre-build"â€¿(<Ë˜â‰>âŸ¨
        "default"â€¿âŸ¨âŸ©
        "sdacore"â€¿âŸ¨
           "pushd {dirproj}"
           "./scripts/autorevision -t hpp > src/sdacore_autorev.hpp"
           "popd"
        âŸ©
    âŸ©)
    "config-clean"â€¿(<Ë˜â‰>âŸ¨
        "default"â€¿âŸ¨
          "rm -rf \
{dirproj}/CMakeFiles \
{dirproj}/CMakeCache.txt \
{dirproj}/err.txt \
{dirproj}/cmake_install.cmake"
        âŸ©
        "ssacore"â€¿âŸ¨
          "rm -rf {dirproj}/buildmb"
        âŸ©
        "turboprop"â€¿âŸ¨âŸ©
    âŸ©)
    "config"â€¿(<Ë˜â‰>âŸ¨
      "default"â€¿âŸ¨
        "cmake \
-DWITH_CONAN=1 \
-S {dirproj} \
-B {dirproj} \
-Dstatic_force_no={static_force_no} \
-Duse_kafka={use_kafka}"
      âŸ©
      "ssacore"â€¿âŸ¨
        "cmake \
-S {dirproj} \
-B {dirproj}/buildmb \
-DSANITIZE=OFF \
-Dmodern_practice=ON \
-Duse_kafka={use_kafka}"
      âŸ©
      "turboprop"â€¿âŸ¨âŸ©
      "svslib"â€¿âŸ¨
        "cmake \
.-DWITH_CONAN=1 \
-DUSE_ACTIVEMQ:BOOL=ON \
-S {dirproj} \
-B {dirproj}"
      âŸ©
      "xcomlib"â€¿âŸ¨
         "cmake \
-DWITH_CONAN=1 \
-DUSE_ACTIVEMQ:BOOL=ON \
-S {dirproj} \
-B {dirproj} \
-Dstatic_force_no={static_force_no}"
      âŸ©
      "xcom"â€¿âŸ¨
         "cmake -DWITH_CONAN=1 \
-S {dirproj} \
-B {dirproj} \
-DCMAKE_BUILD_TYPE=Debug \
-Dstatic_force_no={static_force_no} \
-Duse_kafka={use_kafka}"
      âŸ©
      "age"â€¿âŸ¨
        "cmake -DWITH_CONAN=1 -DWITH_SERVICE=1 \
-S {dirproj} \
-B {dirproj} \
-DCMAKE_BUILD_TYPE=Debug \
-Dstatic_force_no={static_force_no} \
-Duse_kafka={use_kafka}"
      âŸ©
    âŸ©)
    "build-clean"â€¿(<Ë˜â‰>âŸ¨
      "default"â€¿âŸ¨
        "make -C {dirproj} clean"
      âŸ©
      "ssacore"â€¿âŸ¨
        "cmake --build {dirproj}/buildmb --target clean"
      âŸ©
      "xcomlib"â€¿âŸ¨âŸ©
    âŸ©)
    "build"â€¿(<Ë˜â‰>âŸ¨
      "default"â€¿âŸ¨
        "make -C {dirproj} --jobs={nprocs}"
      âŸ©
      "ssacore"â€¿âŸ¨
        "cmake --build {dirproj}/buildmb --parallel={nprocs}"
      âŸ©
    âŸ©)
    "post-build"â€¿(<Ë˜â‰>âŸ¨
      "default"â€¿âŸ¨âŸ©
      "ssacore"â€¿âŸ¨
        "mkdir -p {dirproj}/lib"
        "cp {dirproj}/buildmb/src/libSSA.a {dirproj}/lib/."
        "cp {dirproj}/buildmb/src/ssa_config.h {dirproj}/src/."
        "cp {dirproj}/buildmb/src/ssacore_autorev.hpp {dirproj}/src/."
      âŸ©
      "turboprop"â€¿âŸ¨
        "mkdir -p {dirproj}/lib"
        "cp {dirproj}/src/libTurboProp.a {dirproj}/lib/."
      âŸ©
    âŸ©)
    "package-export"â€¿(<Ë˜â‰>âŸ¨
      "default"â€¿âŸ¨âŸ©
      "ssacore"â€¿âŸ¨
        "conan export-pkg -bf {dirproj} --force {dirproj}/conanfile.py \
{project}/MACHINA-latest@pipeline/testing"
      âŸ©
      "sdacore"â€¿âŸ¨
        "conan export-pkg -bf {dirproj} --force {dirproj}/conanfile.py \
{project}/MACHINA-latest@pipeline/testing"
      âŸ©
      "turboprop"â€¿âŸ¨
        "conan export-pkg -bf {dirproj} --force {dirproj}/conanfile.py \
{project}/MACHINA-latest@pipeline/testing"
      âŸ©
      "svslib"â€¿âŸ¨
        "conan export-pkg -bf {dirproj} --force {dirproj}/conanfile.py \
{project}/MACHINA-latest@pipeline/testing"
      âŸ©
      "xcomlib"â€¿âŸ¨
        "conan export-pkg -bf {dirproj} --force {dirproj}/conanfile.py \
{project}/MACHINA-latest@pipeline/testing"
      âŸ©
    âŸ©)
    "build-image"â€¿(<Ë˜â‰>âŸ¨
      "default"â€¿âŸ¨âŸ©
    âŸ©)
âŸ©

â€¢Out "config-xcom"
â€¢Show (mactions GetValue "config") GetValue "xcom"
â€¢Out "build-xcom"
â€¢Show (mactions GetValue "build") GetValueDefault "xcom"

ReplaceStringsInList â† {
  a â† 0âŠ‘ğ•¨
  b â† 1âŠ‘ğ•¨
  bÂ¨âŒ¾((aâŠ¸â‰¡Â¨ğ•©)/â—‹â¥ŠâŠ¢)ğ•©  # TODO study this
}

SortWithList â† {
  (â‹â‹â‹ğ•¨âŠğ•©)âŠğ•©  # TODO study this
}

GetArgParams â† {
  x â† ((ğ•¨âŠ¸â‰¡âŠ‘)Â¨)âŠ¸/ğ•©
  x (âˆ¾(1âŠ¸â†“)Â¨)â†©
  x
}

GetArgsParams â† {
  GetArgParamsâŸœğ•©Â¨ğ•¨
}

args â† â€¢args

## convert single character argmuments to long arguments; -p -> --projects
# TODO turn into function that takes arbitrary number of replacements, args_short
#args "-p"â€¿"--projects"âŠ¸ReplaceStringsInListâ†©
#args "-a"â€¿"--actions"âŠ¸ReplaceStringsInListâ†©
args (0âŠ‘args_short)âŠ¸ReplaceStringsInListâ†©  # projects
args (1âŠ‘args_short)âŠ¸ReplaceStringsInListâ†©  # actions
#ConvertShortArgs â† {
#{"--projects"Â¨âŒ¾(("-p"âŠ¸â‰¡Â¨ğ•©)/â—‹â¥ŠâŠ¢)ğ•©}args
#}
#args args_short ConvertShortArgs â†©
â€¢Out "original args: "âˆ¾â€¢Fmt args

## group arguments with their sub-arguments, if any
#args â† (+`("--"âŠ¸â‰¡2âŠ¸â†‘)Â¨)âŠ¸âŠ” â€¢args  # group flags with args
{  # block to limit scope of temp vars
  loc_args â† ("--"âŠ¸â‰¡2âŠ¸â†‘)Â¨ args  # locate args
  grp_args â† +`loc_args  # prep to group
  args grp_argsâŠ¸âŠ”â†©  # group args
}
args (Â¬âŸ¨âŸ©âŠ¸â‰¡)Â¨âŠ¸/â†©  # remove empty elements
# TODO convert args to fake association list / dictionary; find out what this means in bqn
â€¢Out "args: "âˆ¾â€¢Fmt args

projectsâ€¿actions â† "--projects"â€¿"--actions" GetArgsParams args
â€¢Out "original projects: "âˆ¾â€¢Fmt projects
â€¢Out "original actions: "âˆ¾â€¢Fmt actions

dep_projectsâ€¿dep_actionsâ€¿clean â† (â‹ˆÂ¨"--dep-projects"â€¿"--dep-actions"â€¿"--clean") âˆŠ args
â€¢Out "dep_projects: "âˆ¾â€¢Fmt dep_projects
â€¢Out "dep_actions: "âˆ¾â€¢Fmt dep_actions
â€¢Out "clean: "âˆ¾â€¢Fmt clean

projects (mprojects SortWithList â·)â†©  # TODO study this
GetDependentProjects â† {
  âŸ¨ğ•©âŸ©âˆ¾âˆ¾GetDependentProjectsÂ¨mproject_deps GetValue ğ•©
}
FillDependentProjects â† {
  (â‰ ğ•©)=1 ? mprojects SortWithList â·GetDependentProjectsâŠ‘ğ•©;
  # if first project is a library, assign to base_library, else first library in mlibraries
  base_library â† (âŠ‘mlibrariesâˆŠâŠ‘ğ•©) â—¶ (âŠ‘ğ•©)â€¿(âŠ‘mlibraries) @
  x â† âˆ¾GetDependentProjectsÂ¨ğ•©
  x âŸ¨base_libraryâŸ©âŠ¸âˆ¾â†©
  x (mprojectsâŠ¸SortWithList â·)â†©
  # remove any libraries the precede base_library
  x (âŠ‘xâŠ’âŸ¨base_libraryâŸ©)âŠ¸â†“â†©
}
projects â†© FillDependentProjectsâŸdep_projects projects
â€¢Out "final projects: "âˆ¾â€¢Fmt projects

actions ((âŠ‘mactions) SortWithList â·)â†©
original_cleans â† (âˆ¨Â´"clean"âŠ¸â·)Â¨âŠ¸/actions
FillDependentActions â† {
  (â‰ ğ•©)=1 ? (1+(âŠ‘mactions)âŠ’ğ•©)â†‘(âŠ‘mactions);
  ix_action_first â† âŠ‘(âŠ‘mactions)âŠ’âŸ¨0âŠ‘ğ•©âŸ©
  ix_action_last â† 1 + âŠ‘(âŠ‘mactions)âŠ’âŸ¨Â¯1âŠ‘ğ•©âŸ©
  (â†•âŒ¾(-âŸœix_action_first)ix_action_last) âŠ (âŠ‘mactions)  # TODO study this
}
actions â†© FillDependentActionsâŸdep_actions actions
actions (Â¬(âˆ¨Â´"clean"âŠ¸â·))Â¨âŠ¸/â†©  # remove any "clean" actions
actions â†© actions âˆ¾ {((âŠ‘mcleans) âˆŠ ğ•©) / 1âŠ‘mcleans} âŸ clean actions
actions original_cleansâŠ¸âˆ¾â†©
actions ((âŠ‘mactions) SortWithList â·)â†©

â€¢Out "final actions: "âˆ¾â€¢Fmt actions
